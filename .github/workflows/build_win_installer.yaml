name: Build Windows Installer (Win11+ compatible)

on:
  workflow_dispatch:
  # push:
  #   tags: ['v*']

jobs:
  build-windows:
    runs-on: windows-latest  # Windows Server 2022 â†’ has full Win11 SDK support
    defaults:
      run:
        shell: powershell

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12 (official python.org build)
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          architecture: x64
          cache: pip

      - name: Upgrade pip & install build tools
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install "cx_Freeze>=7.1" pywin32

      - name: Download and embed VC++ Redistributable (required on clean Win11 installs)
        run: |
          Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile "vc_redist.x64.exe"

      - name: Build MSI + Portable ZIP with cx_Freeze
        working-directory: ./src
        run: |
          python build_with_cxfreeze_multiarch_setup.py bdist_msi bdist_zip

      - name: Extract version from pyproject.toml
        id: version
        run: |
          $ver = python - <<EOF
          import toml, sys
          data = toml.load("../pyproject.toml")
          print(data["project"]["version"])
          EOF
          echo "VERSION=$ver" >> $env:GITHUB_OUTPUT

      - name: Prepare final artifacts
        run: |
          $ver = "${{ steps.version.outputs.VERSION }}"
          New-Item -ItemType Directory -Path upload -Force

          Move-Item "src/dist/*.msi" "upload/BrainWash-$ver-Windows-x64-Installer.msi"
          Move-Item "src/dist/*.zip" "upload/BrainWash-$ver-Windows-x64-Portable.zip"

          # Also copy VC++ redist for users without it
          Copy-Item "../vc_redist.x64.exe" "upload/VC_Redist_2022_x64.exe"

      - name: Upload Installer (MSI)
        uses: actions/upload-artifact@v4
        with:
          name: BrainWash-${{ steps.version.outputs.VERSION }}-Windows11-x64-Installer
          path: upload/*Installer.msi

      - name: Upload Portable ZIP
        uses: actions/upload-artifact@v4
        with:
          name: BrainWash-${{ steps.version.outputs.VERSION }}-Windows11-x64-Portable
          path: upload/*Portable.zip

      - name: Upload VC++ Redist (recommended for clean installs)
        uses: actions/upload-artifact@v4
        with:
          name: VC_Redistributable
          path: upload/VC_Redist_2022_x64.exe
