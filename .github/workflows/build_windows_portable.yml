name: Build Windows portable ZIP with cx_Freeze

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest]
        python-version: ["3.12"]

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Install uv (also installs the pinned Python version)
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          python-version: ${{ matrix.python-version }}

      # List files for debugging
      - name: List files
        run: dir .

      # Install dependencies (runtime + build tools)
      - name: Install dependencies
        run: uv sync --frozen --group build

      # Extract version from pyproject.toml
      - name: Extract version from pyproject.toml
        shell: pwsh
        run: |
          $version = uv run python -c "import toml; print(toml.load('pyproject.toml')['project']['version'])"
          echo "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Output "Extracted version: $version"

      # Build the executable
      - name: Build with cx_Freeze
        working-directory: ./src
        run: uv run python build_with_cxfreeze_multiarch_setup.py build_exe > cxbuild_exe.log
        shell: cmd

      - name: List build files for debugging
        working-directory: ./src
        run: dir /s build\ || echo "build\ not found"
        shell: cmd

      # Package into portable ZIP
      - name: Package portable ZIP
        working-directory: ./src
        shell: pwsh
        run: |
          $exe_dir = Get-ChildItem -Recurse -Path build -Directory | Where-Object { Test-Path (Join-Path $_.FullName "brainwash.exe") } | Select-Object -ExpandProperty FullName -First 1
          if (-not $exe_dir) { Write-Error "Executable directory not found in build/"; exit 1 }
          $version = $env:VERSION
          $zip_path = "../brainwash-${version}-windows-portable.zip"
          Compress-Archive -Path "$exe_dir\*" -DestinationPath $zip_path -CompressionLevel Optimal
          Write-Output "Created portable ZIP from $exe_dir`: $zip_path"

      - name: List artifacts for debugging
        run: dir brainwash-*.zip
        shell: cmd

      # Upload artifacts
      - name: Upload Windows portable ZIP
        uses: actions/upload-artifact@v4
        with:
          name: brainwash-${{ env.VERSION }}-windows-portable
          path: brainwash-${{ env.VERSION }}-windows-portable.zip
          compression-level: 0
