name: Build Windows portable ZIP with cx_Freeze

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest]
        python-version: ["3.12"]

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Install uv (also installs the pinned Python version)
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          python-version: ${{ matrix.python-version }}

      # List files for debugging
      - name: List files
        run: dir .

      # Install dependencies (runtime + build tools)
      - name: Install dependencies
        run: uv sync --frozen --group build

      # Extract version from pyproject.toml
      - name: Extract version from pyproject.toml
        shell: pwsh
        run: |
          $version = uv run python -c "import toml; print(toml.load('pyproject.toml')['project']['version'])"
          echo "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Output "Extracted version: $version"

      # Build the executable
      - name: Build with cx_Freeze
        working-directory: ./src
        run: uv run python build_with_cxfreeze_multiarch_setup.py build_exe > cxbuild_exe.log
        shell: cmd

      - name: List build files for debugging
        working-directory: ./src
        run: dir /s build\ || echo "build\ not found"
        shell: cmd

      # Find the exe directory and expose it for upload
      - name: Find exe directory
        working-directory: ./src
        shell: pwsh
        run: |
          $exe_dir = Get-ChildItem -Recurse -Path build -Directory | Where-Object { Test-Path (Join-Path $_.FullName "brainwash.exe") } | Select-Object -ExpandProperty FullName -First 1
          if (-not $exe_dir) { Write-Error "Executable directory not found in build/"; exit 1 }
          # Strip GITHUB_WORKSPACE prefix to get a repo-root-relative path
          $rel = $exe_dir.Substring("$env:GITHUB_WORKSPACE\".Length)
          Write-Output "EXE_DIR=$rel" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Output "Found exe directory (repo-relative): $rel"

      # Upload artifacts â€” upload-artifact zips the directory itself, no manual zip needed
      - name: Upload Windows portable ZIP
        uses: actions/upload-artifact@v4
        with:
          name: brainwash-${{ env.VERSION }}-windows-portable
          path: ${{ env.EXE_DIR }}
          compression-level: 0
